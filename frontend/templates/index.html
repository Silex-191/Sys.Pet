<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sys.pet // TERMINAL</title>
    <style>
        /* --- CSS: Cyberpunk Theme --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --neon-green: #0f0;
            --neon-pink: #f0f;
            --neon-blue: #0ff;
            --text-color: #eee;
            --scanline: rgba(0, 255, 0, 0.05);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* CRT Effect Overlay */
        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto 1fr auto;
            gap: 15px;
            width: 100%;
            max-width: 900px;
            padding: 20px;
            border: 2px solid var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
            background: var(--panel-bg);
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            text-align: center;
            border-bottom: 1px dashed var(--neon-green);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        header h1 {
            margin: 0 0 5px 0;
            font-size: 1.5em;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green);
        }

        .status-badge {
            font-size: 0.8em;
            background: var(--neon-green);
            color: black;
            padding: 3px 8px;
            font-weight: bold;
            border-radius: 3px;
            display: inline-block;
        }

        .status-badge.dead {
            background: #f00;
            color: white;
        }

        .status-badge.evolving {
            background: var(--neon-pink);
            color: white;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Pet Container */
        .pet-container {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 280px;
            border: 1px solid #333;
            background: #0a0a0a;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .pet-sprite {
            font-size: 120px;
            transition: transform 0.3s ease, filter 0.3s ease;
            cursor: pointer;
            filter: drop-shadow(0 0 15px var(--neon-green));
            user-select: none;
        }

        .pet-sprite:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 25px var(--neon-green));
        }

        .pet-sprite:active {
            transform: scale(0.95);
        }

        .pet-name {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .pet-status-msg {
            font-size: 0.9em;
            color: var(--neon-pink);
            margin-top: 5px;
            height: 20px;
        }

        /* Stats Grid */
        .stats {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat {
            border: 1px solid var(--neon-green);
            padding: 10px;
            background: #0a0a0a;
            border-radius: 3px;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--neon-green);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .stat-bar {
            width: 100%;
            height: 20px;
            background: #222;
            border: 1px solid #444;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            transition: width 0.3s ease;
            position: relative;
        }

        .stat-fill::after {
            content: attr(data-value);
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: black;
        }

        .stat-fill.danger {
            background: linear-gradient(90deg, #f00, #ff6600);
        }

        .stat-fill.warn {
            background: linear-gradient(90deg, #ff6600, var(--neon-pink));
        }

        /* Code Input */
        .code-input-section {
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .code-input-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--neon-green);
            text-transform: uppercase;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .file-upload-btn {
            padding: 8px 15px;
            background: transparent;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            text-transform: uppercase;
            transition: all 0.2s ease;
            border-radius: 3px;
        }

        .file-upload-btn:hover {
            background: var(--neon-blue);
            color: black;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        #file-input {
            display: none;
        }

        .file-info {
            font-size: 0.8em;
            color: var(--neon-pink);
            flex-grow: 1;
        }

        .code-input {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
            min-height: 80px;
            border-radius: 3px;
        }

        .code-input:focus {
            outline: none;
            box-shadow: 0 0 15px var(--neon-green);
            border-color: var(--neon-blue);
        }

        .input-hint {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
        }

        /* Buttons */
        .buttons {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 15px;
            background: transparent;
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            text-transform: uppercase;
            transition: all 0.2s ease;
            border-radius: 3px;
        }

        button:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 15px var(--neon-green);
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button.danger {
            border-color: #f00;
            color: #f00;
        }

        button.danger:hover {
            background: #f00;
            color: white;
            box-shadow: 0 0 15px #f00;
        }

        .success-msg {
            color: var(--neon-green);
            background: rgba(0, 255, 0, 0.1);
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
            display: none;
        }

        .error-msg {
            color: #f00;
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 2px solid var(--neon-green);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .dashboard {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .pet-sprite {
                font-size: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- HEADER -->
        <header>
            <h1>üéÆ SYS.PET üéÆ</h1>
            <p style="margin: 5px 0; font-size: 0.9em;">
                –¢–∞–º–∞–≥–æ—á–∏, –∑–∞–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞ <span style="color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue);">—Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö</span>
            </p>
            <div id="status-badge" class="status-badge">LOADING...</div>
        </header>

        <!-- PET CONTAINER -->
        <div class="pet-container">
            <div class="pet-sprite" id="pet-sprite" title="–ö–ª–∞—Ü–Ω–∏, —á—Ç–æ–±—ã –ø–æ–≥–ª–∞–¥–∏—Ç—å!">üë∂</div>
            <div class="pet-name" id="pet-name">sys.pet</div>
            <div class="pet-status-msg" id="pet-status-msg">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <!-- STATS -->
        <div class="stats" id="stats">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>

        <!-- CODE INPUT -->
        <div class="code-input-section">
            <label for="code-input">–ö–æ—Ä–º–∏ –ø–∏—Ç–æ–º—Ü–∞ –∫–æ–¥–æ–º:</label>
            <div class="input-controls">
                <input type="file" id="file-input" accept=".py,.c,.cpp,.h,.hpp,.txt,.md" />
                <button class="file-upload-btn" id="upload-btn">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                <span class="file-info" id="file-info"></span>
            </div>
            <textarea id="code-input" class="code-input" placeholder="–í—Å—Ç–∞–≤—å –∫–æ–¥ –∑–¥–µ—Å—å... –ü–∏—Ç–æ–º–µ—Ü –ª—é–±–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —á–µ—Ç–Ω–æ—Å—Ç—å!"></textarea>
            <div class="input-hint">üí° Enter - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter - –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</div>
        </div>

        <!-- BUTTONS -->
        <div class="buttons">
            <button id="feed-btn">üçΩÔ∏è –ü–æ–∫–æ—Ä–º–∏—Ç—å</button>
            <button id="rest-btn">üò¥ –û—Ç–¥–æ—Ö–Ω—É—Ç—å</button>
            <button id="reset-btn" class="danger">‚ö° –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>

        <!-- MESSAGES -->
        <div id="success-msg" class="success-msg"></div>
        <div id="error-msg" class="error-msg"></div>
    </div>

    <script>
        // ===== API HELPER =====
        class SysPetAPI {
            constructor(baseUrl = 'http://localhost:8000') {
                this.baseUrl = baseUrl;
            }

            async getPetState() {
                return this.get('/api/pet');
            }

            async feedPet(code) {
                const params = new URLSearchParams({ code });
                return this.post('/api/feed', params);
            }

            async petAction(action) {
                const params = new URLSearchParams({ action });
                return this.post('/api/pet-action', params);
            }

            async get(endpoint) {
                const response = await fetch(this.baseUrl + endpoint);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }

            async post(endpoint, data) {
                const response = await fetch(this.baseUrl + endpoint, {
                    method: 'POST',
                    body: data,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            }
        }

        // ===== UI HELPER =====
        const api = new SysPetAPI();
        let petState = null;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const petSprite = document.getElementById('pet-sprite');
        const petName = document.getElementById('pet-name');
        const petStatusMsg = document.getElementById('pet-status-msg');
        const statusBadge = document.getElementById('status-badge');
        const statsContainer = document.getElementById('stats');
        const codeInput = document.getElementById('code-input');
        const feedBtn = document.getElementById('feed-btn');
        const restBtn = document.getElementById('rest-btn');
        const resetBtn = document.getElementById('reset-btn');
        const successMsg = document.getElementById('success-msg');
        const errorMsg = document.getElementById('error-msg');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInfo = document.getElementById('file-info');

        // ===== RENDER FUNCTIONS =====
        function renderStats() {
            if (!petState) return;

            statsContainer.innerHTML = '';

            const stats = [
                { label: 'HP', value: petState.hp, max: 100 },
                { label: '–ì–û–õ–û–î', value: 100 - petState.hunger, max: 100 },
                { label: '–£–°–¢–ê–õ–û–°–¢–¨', value: petState.fatigue, max: 100 },
                { label: '–°–ß–ê–°–¢–¨–ï', value: petState.happiness, max: 100 },
                { label: '–í–ï–° (RAM)', value: petState.weight, max: 100 },
                { label: '–£–†–û–í–ï–ù–¨', value: petState.course, max: 10 },
            ];

            stats.forEach(stat => {
                const percent = Math.min(100, (stat.value / stat.max) * 100);
                const isDanger = stat.label === 'HP' && percent < 30;
                const isWarn = percent > 80 && stat.label !== 'HP';

                const statDiv = document.createElement('div');
                statDiv.className = 'stat';
                statDiv.innerHTML = `
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-bar">
                        <div class="stat-fill ${isDanger ? 'danger' : isWarn ? 'warn' : ''}"
                             style="width: ${percent}%"
                             data-value="${Math.round(stat.value)}/${stat.max}"></div>
                    </div>
                `;
                statsContainer.appendChild(statDiv);
            });
        }

        function renderPet() {
            if (!petState) return;

            petName.textContent = petState.name;
            petStatusMsg.textContent = petState.status_message;
            petSprite.textContent = petState.skin;

            statusBadge.textContent = petState.status.toUpperCase();
            statusBadge.className = 'status-badge ' + petState.status;

            renderStats();
        }

        function showMessage(text, isError = false) {
            const el = isError ? errorMsg : successMsg;
            el.textContent = text;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // ===== UPDATE LOOP =====
        async function updatePet() {
            try {
                petState = await api.getPetState();
                renderPet();
            } catch (err) {
                console.error('Update error:', err);
            }
        }

        setInterval(updatePet, 500);  // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 500ms

        // ===== FILE UPLOAD HANDLING =====
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const validExtensions = ['.py', '.c', '.cpp', '.h', '.hpp', '.txt', '.md'];
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExt)) {
                showMessage('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!', true);
                return;
            }

            try {
                const text = await file.text();
                codeInput.value = text;
                fileInfo.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                showMessage(`–§–∞–π–ª "${file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
            } catch (err) {
                showMessage('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message, true);
            }
        });

        // ===== EVENT LISTENERS =====
        feedBtn.addEventListener('click', async () => {
            const code = codeInput.value.trim();
            if (!code) {
                showMessage('–í–≤–µ–¥–∏ –∫–æ–¥!', true);
                return;
            }

            feedBtn.disabled = true;
            feedBtn.innerHTML = '<span class="loading"></span>';

            try {
                const result = await api.feedPet(code);
                if (result.success) {
                    showMessage(result.message);
                    codeInput.value = '';
                } else {
                    showMessage(result.message, true);
                }
                await updatePet();
            } catch (err) {
                showMessage('–û—à–∏–±–∫–∞: ' + err.message, true);
            } finally {
                feedBtn.disabled = false;
                feedBtn.innerHTML = 'üçΩÔ∏è –ü–æ–∫–æ—Ä–º–∏—Ç—å';
            }
        });

        codeInput.addEventListener('keydown', (e) => {
            // Enter without Shift: submit
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                feedBtn.click();
            }
            // Shift+Enter: allow default (new line)
        });

        restBtn.addEventListener('click', async () => {
            try {
                const result = await api.petAction('rest');
                showMessage(result.message);
                await updatePet();
            } catch (err) {
                showMessage('–û—à–∏–±–∫–∞: ' + err.message, true);
            }
        });

        petSprite.addEventListener('click', async () => {
            try {
                const result = await api.petAction('pet');
                showMessage('–í—ã –ø–æ–≥–ª–∞–¥–∏–ª–∏ –ø–∏—Ç–æ–º—Ü–∞! üíï');
                await updatePet();
            } catch (err) {
                console.error(err);
            }
        });

        resetBtn.addEventListener('click', async () => {
            if (confirm('–¢–æ—á–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞?')) {
                try {
                    const result = await api.petAction('reset');
                    showMessage('üåÄ –ü–∏—Ç–æ–º–µ—Ü –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω!');
                    await updatePet();
                } catch (err) {
                    showMessage('–û—à–∏–±–∫–∞: ' + err.message, true);
                }
            }
        });

        // ===== INIT =====
        updatePet();
    </script>
</body>
</html>